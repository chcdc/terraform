---
- hosts: master
  become: true
  vars:
    sudoers:
      - ubuntu
  tasks:
    - name: Get Images
      command: "{{ item }}"
      with_items:
        - kubeadm config images pull

    - name: Initialize the Kubernetes cluster using kubeadm
      command: kubeadm init --node-name {{ hostname }} --pod-network-cidr=192.168.0.0/16
      #command: kubeadm init --apiserver-advertise-address="{{ node_ip }}" --apiserver-cert-extra-sans="{{ node_ip }}"  --node-name k8s-master --pod-network-cidr=192.168.0.0/16

    - name: Creates directory
      file:
        path: /home/ubuntu/.kube/
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: 0775
        recurse: yes

    - name: Copy config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        owner: ubuntu
        group: ubuntu
        mode: 0644
        remote_src: yes

    - name: Change kubeconfig file permission
      file:
        path: /home/ubuntu/.kube/config 
        owner: "{{ ansible_effective_user_id }}"
        group: "{{ ansible_effective_group_id }}"

    - name: Install calico pod network
      become: false
      command: kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml #https://docs.projectcalico.org/v3.4/getting-started/kubernetes/installation/hosted/calico.yaml
  #
    - name: Generate join command
      command: kubeadm token create --print-join-command
      register: join_command
  #
    - name: Copy join command to local file
      become: false
      local_action: copy content="{{ join_command.stdout_lines[0] }}" dest="join-command"

    - name: Copy join command remote to local file
      copy:
        src: join-command
        dest: .join-command
        mode: u+rw,g-wx,o-rwx
